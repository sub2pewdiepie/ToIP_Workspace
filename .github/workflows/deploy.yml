name: Deploy to VPS

on: push
  # branches:
  #   - dev

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Execute SSH commands
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Set up SSH for GitHub access
            mkdir -p ~/.ssh
            echo "${{ secrets.REPO_SSH_KEY }}" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan github.com >> ~/.ssh/known_hosts

            # Clone the private repository using SSH
            cd sussy_project
            rm -rf ToIP_Workspace
            git clone -b dev git@github.com:${{ github.repository }}.git ToIP_Workspace

            # Build and deploy
            cd ToIP_Workspace
            docker compose build --no-cache
            chmod +x ./gen_env.sh
            ./gen_env.sh
            docker compose up -d
